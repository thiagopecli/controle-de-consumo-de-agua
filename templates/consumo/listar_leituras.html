{% extends 'consumo/base.html' %}
{% load filtros_personalizados %}

{% block title %}Leituras - Sistema de Controle de Ãgua{% endblock %}

{% block content %}
<div class="leituras-page">
    <h2>HistÃ³rico de Leituras</h2>
    
    <form method="get" class="search-box" style="display:flex; gap:0.5rem; align-items:center;">
        <input type="text" id="searchInput" name="lote" value="{{ lote_filtro }}" placeholder="Buscar por nÃºmero do lote ou 'ADM'..." class="search-input">
        <button type="submit" class="btn btn-primary">Filtrar</button>
        <a href="?" class="btn btn-secondary">Limpar</a>
    </form>
    
    <div class="table-container">
        <table class="data-table" id="leiturasTable">
            <thead>
                <tr>
                    <th>Data/Hora</th>
                    <th>HidrÃ´metro</th>
                    <th>Lote</th>
                    <th>Tipo</th>
                    <th>Leitura (mÂ³)</th>
                    <th>Consumo (Litros)</th>
                    <th>PerÃ­odo</th>
                    <th>ResponsÃ¡vel</th>
                    <th>Foto</th>
                    <th>ObservaÃ§Ãµes</th>
                </tr>
            </thead>
            <tbody>
                {% for leitura in leituras %}
                <tr>
                    <td><strong>{{ leitura.data_leitura|date:"d/m/Y H:i" }}</strong></td>
                    <td>{{ leitura.hidrometro.numero }}</td>
                    <td>{{ leitura.hidrometro.lote.numero }}{% if leitura.hidrometro.lote.tipo == 'administracao' %} (ADM){% endif %}</td>
                    <td>
                        <span class="badge badge-{{ leitura.hidrometro.lote.tipo }}">
                            {{ leitura.hidrometro.lote.get_tipo_display }}
                        </span>
                    </td>
                    <td><strong>{{ leitura.leitura }}</strong></td>
                    <td>
                        {% if leitura.consumo_desde_ultima_leitura_litros > 0 %}
                        <span style="color: #0891b2; font-weight: 700;">
                            {{ leitura.consumo_desde_ultima_leitura_litros|floatformat:0|formatar_litros }} L
                        </span>
                        {% else %}
                        <span style="color: #94a3b8;">â€”</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if leitura.periodo == 'manha' %}
                        <span class="badge badge-info">ğŸŒ… ManhÃ£</span>
                        {% else %}
                        <span class="badge badge-warning">ğŸŒ† Tarde</span>
                        {% endif %}
                    </td>
                    <td>{{ leitura.responsavel|default:"N/A" }}</td>
                    <td>
                        {% if leitura.foto %}
                        <a href="{{ leitura.foto.url }}" target="_blank" class="btn btn-sm btn-info">
                            ğŸ“· Ver Foto
                        </a>
                        {% else %}
                        <span style="color: #94a3b8;">Sem foto</span>
                        {% endif %}
                    </td>
                    <td>{{ leitura.observacoes|default:"â€”"|truncatewords:5 }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="10" class="text-center">Nenhuma leitura cadastrada</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- PaginaÃ§Ã£o -->
    {% if leituras.has_other_pages %}
    <div style="margin-top: 2rem; display: flex; justify-content: center; align-items: center; gap: 1rem;">
        {% if leituras.has_previous %}
            <a href="?page=1{% if lote_filtro %}&lote={{ lote_filtro }}{% endif %}" class="btn btn-secondary">Â« Primeira</a>
            <a href="?page={{ leituras.previous_page_number }}{% if lote_filtro %}&lote={{ lote_filtro }}{% endif %}" class="btn btn-secondary">â€¹ Anterior</a>
        {% endif %}
        
        <span style="padding: 0.5rem 1rem; background: white; border-radius: 5px; font-weight: 600;">
            PÃ¡gina {{ leituras.number }} de {{ leituras.paginator.num_pages }}
        </span>
        
        {% if leituras.has_next %}
            <a href="?page={{ leituras.next_page_number }}{% if lote_filtro %}&lote={{ lote_filtro }}{% endif %}" class="btn btn-secondary">PrÃ³xima â€º</a>
            <a href="?page={{ leituras.paginator.num_pages }}{% if lote_filtro %}&lote={{ lote_filtro }}{% endif %}" class="btn btn-secondary">Ãšltima Â»</a>
        {% endif %}
    </div>
    {% endif %}
    
    <div class="info-box" style="margin-top: 2rem;">
        <h3>â„¹ï¸ InformaÃ§Ãµes</h3>
        <p><strong>Total de Leituras{% if lote_filtro %} (Lote {{ lote_filtro }}){% endif %}:</strong> {{ leituras.paginator.count|default:0 }}</p>
        <p><strong>Exibindo:</strong> {{ leituras.start_index|default:0 }} - {{ leituras.end_index|default:0 }} de {{ leituras.paginator.count|default:0 }} leituras</p>
        <p>As leituras sÃ£o ordenadas da mais recente para a mais antiga.</p>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        // Submete o formulÃ¡rio ao pressionar Enter
        searchInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                this.form.submit();
            }
        });
    }
});
</script>
{% endblock %}
