{% extends 'consumo/base.html' %}

{% block title %}Hidr√¥metros - Sistema de Controle de √Ågua{% endblock %}

{% block content %}
<div class="hidrometros-page">
    <h2>Lista de Hidr√¥metros</h2>
    
    <div class="search-box">
        <input type="text" id="searchInput" placeholder="Buscar por n√∫mero do lote..." class="search-input">
    </div>
    
    <div class="table-container">
        <table class="data-table" id="hidrometrosTable">
            <thead>
                <tr>
                    <th>N√∫mero</th>
                    <th>Lote</th>
                    <th>Tipo</th>
                    <th>Localiza√ß√£o</th>
                    <th>Data Instala√ß√£o</th>
                    <th>Status</th>
                    <th>Leitura de Hoje</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody>
                {% for hidrometro in hidrometros %}
                <tr class="{% if hidrometro.leituras_hoje %}row-leitura-hoje{% endif %}">
                    <td><strong>{{ hidrometro.numero }}</strong></td>
                    <td>{{ hidrometro.lote.numero }}{% if hidrometro.lote.tipo == 'administracao' %} (ADM){% endif %}</td>
                    <td>
                        <span class="badge badge-{{ hidrometro.lote.tipo }}">
                            {{ hidrometro.lote.get_tipo_display }}
                        </span>
                    </td>
                    <td>{{ hidrometro.localizacao|default:"N/A" }}</td>
                    <td>{{ hidrometro.data_instalacao|date:"d/m/Y" }}</td>
                    <td>
                        {% if hidrometro.ativo %}
                        <span class="badge badge-success">Ativo</span>
                        {% else %}
                        <span class="badge badge-danger">Inativo</span>
                        {% endif %}
                    </td>
                    <td class="coluna-leitura-hoje">
                        {% if hidrometro.leituras_hoje %}
                        <span class="status-pill status-ok">‚úî Leitura registrada</span>
                        <div class="status-meta">√öltima: {{ hidrometro.ultima_leitura|date:"d/m H:i" }}</div>
                        {% else %}
                        <span class="status-pill status-pending">Pendente</span>
                        <div class="status-meta status-meta-muted">
                            {% if hidrometro.ultima_leitura %}
                                √öltima: {{ hidrometro.ultima_leitura|date:"d/m H:i" }}
                            {% else %}
                                Sem leituras registradas
                            {% endif %}
                        </div>
                        {% endif %}
                    </td>
                    <td class="coluna-acoes">
                        <div class="btn-group-vertical">
                            <a href="{% url 'consumo:graficos_lote' hidrometro.lote.id %}" class="btn btn-sm btn-success">
                                üìä Detalhes
                            </a>
                            <a href="{% url 'consumo:registrar_leitura' %}?hidrometro={{ hidrometro.id }}" class="btn btn-sm btn-primary">
                                üìù Nova Leitura
                            </a>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="8" class="text-center">Nenhum hidr√¥metro cadastrado</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Pagina√ß√£o -->
    {% if hidrometros.has_other_pages %}
    <div style="margin-top: 2rem; display: flex; justify-content: center; align-items: center; gap: 1rem;">
        {% if hidrometros.has_previous %}
            <a href="?page=1" class="btn btn-secondary">¬´ Primeira</a>
            <a href="?page={{ hidrometros.previous_page_number }}" class="btn btn-secondary">‚Äπ Anterior</a>
        {% endif %}
        
        <span style="padding: 0.5rem 1rem; background: white; border-radius: 5px; font-weight: 600;">
            P√°gina {{ hidrometros.number }} de {{ hidrometros.paginator.num_pages }}
        </span>
        
        {% if hidrometros.has_next %}
            <a href="?page={{ hidrometros.next_page_number }}" class="btn btn-secondary">Pr√≥xima ‚Ä∫</a>
            <a href="?page={{ hidrometros.paginator.num_pages }}" class="btn btn-secondary">√öltima ¬ª</a>
        {% endif %}
    </div>
    {% endif %}
    
    <div class="info-box" style="margin-top: 2rem;">
        <h3>‚ÑπÔ∏è Informa√ß√µes</h3>
        <p><strong>Total de Hidr√¥metros Ativos:</strong> {{ hidrometros.paginator.count|default:0 }}</p>
        <p><strong>Exibindo:</strong> {{ hidrometros.start_index|default:0 }} - {{ hidrometros.end_index|default:0 }} de {{ hidrometros.paginator.count|default:0 }} hidr√¥metros</p>
        <p>Os hidr√¥metros s√£o ordenados por n√∫mero.</p>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const table = document.getElementById('hidrometrosTable');
    
    if (searchInput && table) {
        searchInput.addEventListener('keyup', function() {
            const searchValue = this.value.trim();
            const tbody = table.getElementsByTagName('tbody')[0];
            if (!tbody) return;
            
            const rows = tbody.getElementsByTagName('tr');
            
            // Se digitar "adm" (case insensitive), mostra apenas lotes ADM
            const buscaAdm = searchValue.toLowerCase() === 'adm';
            
            for (let row of rows) {
                const cells = row.getElementsByTagName('td');
                // Coluna 1 (√≠ndice 1) √© o Lote
                if (cells.length > 1) {
                    const loteTextOriginal = cells[1].textContent.trim();
                    const isAdm = loteTextOriginal.includes('(ADM)');
                    
                    // Se o campo est√° vazio, mostra todos
                    if (searchValue === '') {
                        row.style.display = '';
                    } 
                    // Se busca por "adm", mostra apenas lotes ADM
                    else if (buscaAdm) {
                        row.style.display = isAdm ? '' : 'none';
                    }
                    // Caso contr√°rio, busca por n√∫mero exato do lote
                    else {
                        let loteNumero = loteTextOriginal.replace(/\s*\(ADM\)\s*/gi, '').trim();
                        row.style.display = loteNumero === searchValue ? '' : 'none';
                    }
                } else {
                    row.style.display = '';
                }
            }
        });
    }
});
</script>
{% endblock %}
