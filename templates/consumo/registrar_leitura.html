{% extends 'consumo/base.html' %}

{% block title %}Registrar Leitura - Sistema de Controle de √Ågua{% endblock %}

{% block content %}
<div class="registrar-leitura-page">
    <h2>Registrar Leitura de Hidr√¥metro</h2>
    
    <div class="form-container">
        <form id="leituraForm">
            {% csrf_token %}
            <div class="form-group">
                <label for="hidrometro">Hidr√¥metro *</label>
                <select id="hidrometro" name="hidrometro" class="form-control" required>
                    <option value="">Selecione um hidr√¥metro</option>
                    {% for hidrometro in hidrometros %}
                    <option value="{{ hidrometro.id }}" data-lote="{{ hidrometro.lote.numero }}">
                        {{ hidrometro.numero }} - Lote {{ hidrometro.lote.numero }}{% if hidrometro.lote.tipo == 'administracao' %} (ADM){% endif %}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="leitura">Leitura (m¬≥) *</label>
                    <input type="text" id="leitura" name="leitura" class="form-control" 
                           required placeholder="0,000" maxlength="9">
                </div>
                
                <div class="form-group">
                    <label for="periodo">Per√≠odo *</label>
                    <select id="periodo" name="periodo" class="form-control" required>
                        <option value="">Selecione</option>
                        <option value="manha">Manh√£</option>
                        <option value="tarde">Tarde</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="data_leitura">Data e Hora *</label>
                    <input type="datetime-local" id="data_leitura" name="data_leitura" 
                           class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="responsavel">Respons√°vel</label>
                    <input type="text" id="responsavel" name="responsavel" 
                           class="form-control" placeholder="Nome do respons√°vel">
                </div>
            </div>
            
            <div class="form-group">
                <label for="observacoes">Observa√ß√µes</label>
                <textarea id="observacoes" name="observacoes" class="form-control" 
                          rows="3" placeholder="Observa√ß√µes adicionais (opcional)"></textarea>
            </div>
            
            <div class="form-group">
                <label for="foto">Foto da Leitura</label>
                <input type="file" id="foto" name="foto" class="form-control" accept="image/*">
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary btn-lg">
                    üíæ Salvar Leitura
                </button>
                <button type="reset" class="btn btn-secondary btn-lg">
                    üîÑ Limpar
                </button>
            </div>
        </form>
        
        <div id="mensagem" class="alert" style="display: none;"></div>
    </div>
    
    <div class="info-box">
        <h3>‚ÑπÔ∏è Informa√ß√µes</h3>
        <ul>
            <li>Preencha todos os campos obrigat√≥rios marcados com *</li>
            <li>A leitura deve ser em metros c√∫bicos (m¬≥)</li>
            <li>Selecione o per√≠odo correto: Manh√£ ou Tarde</li>
            <li>A foto √© opcional mas recomendada para registro</li>
        </ul>
    </div>
</div>

<script>
// Fun√ß√£o para obter cookie CSRF
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Definir data e hora atual ao carregar a p√°gina
document.addEventListener('DOMContentLoaded', function() {
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    document.getElementById('data_leitura').value = now.toISOString().slice(0, 16);
    
    // Formatar campo de leitura com v√≠rgula
    const leituraInput = document.getElementById('leitura');
    
    leituraInput.addEventListener('input', function(e) {
        let valor = this.value;
        
        // Remove tudo exceto n√∫meros e v√≠rgula
        valor = valor.replace(/[^\d,]/g, '');
        
        // Permite apenas uma v√≠rgula
        const partes = valor.split(',');
        if (partes.length > 2) {
            valor = partes[0] + ',' + partes.slice(1).join('');
        }
        
        // Limita a 5 d√≠gitos antes da v√≠rgula
        if (partes[0] && partes[0].length > 5) {
            partes[0] = partes[0].substring(0, 5);
            valor = partes.join(',');
        }
        
        // Limita a 3 d√≠gitos ap√≥s a v√≠rgula
        if (partes[1] && partes[1].length > 3) {
            partes[1] = partes[1].substring(0, 3);
            valor = partes.join(',');
        }
        
        this.value = valor;
        
        // Valida se o valor n√£o excede 99999
        const valorNumerico = parseFloat(valor.replace(',', '.'));
        if (valorNumerico > 99999) {
            this.value = '99999';
            alert('‚ö†Ô∏è O valor m√°ximo permitido √© 99999 m¬≥');
        }
    });
    
    // Adiciona v√≠rgula automaticamente se s√≥ digitar n√∫meros inteiros
    leituraInput.addEventListener('blur', function() {
        if (this.value && !this.value.includes(',')) {
            this.value = this.value + ',000';
        }
    });
});

// Submeter formul√°rio
document.getElementById('leituraForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // Pegar e converter valor da leitura (v√≠rgula para ponto)
    let leituraValor = document.getElementById('leitura').value.replace(',', '.');
    const leituraNum = parseFloat(leituraValor);
    
    // Validar leitura antes de enviar
    if (isNaN(leituraNum) || leituraNum < 0) {
        alert('‚ùå Erro: Informe um valor v√°lido para a leitura');
        return;
    }
    
    if (leituraNum > 99999) {
        alert('‚ùå Erro: O valor da leitura n√£o pode ser maior que 99999 m¬≥');
        return;
    }
    
    const formData = new FormData();
    formData.append('hidrometro', document.getElementById('hidrometro').value);
    formData.append('leitura', leituraValor);  // Envia com ponto decimal
    formData.append('data_leitura', document.getElementById('data_leitura').value);
    formData.append('periodo', document.getElementById('periodo').value);
    formData.append('responsavel', document.getElementById('responsavel').value);
    formData.append('observacoes', document.getElementById('observacoes').value);
    
    const foto = document.getElementById('foto').files[0];
    if (foto) {
        formData.append('foto', foto);
    }
    
    // Obter CSRF token
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                      getCookie('csrftoken');
    
    try {
        const response = await fetch('/api/leituras/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken
            },
            body: formData
        });
        
        const data = await response.json();
        const mensagemDiv = document.getElementById('mensagem');
        
        if (response.ok) {
            mensagemDiv.className = 'alert alert-success';
            mensagemDiv.textContent = '‚úÖ Leitura registrada com sucesso!';
            mensagemDiv.style.display = 'block';
            document.getElementById('leituraForm').reset();
            
            // Redefinir data/hora atual
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('data_leitura').value = now.toISOString().slice(0, 16);
        } else {
            mensagemDiv.className = 'alert alert-error';
            mensagemDiv.textContent = '‚ùå Erro ao registrar leitura: ' + JSON.stringify(data);
            mensagemDiv.style.display = 'block';
        }
        
        setTimeout(() => {
            mensagemDiv.style.display = 'none';
        }, 5000);
        
    } catch (error) {
        const mensagemDiv = document.getElementById('mensagem');
        mensagemDiv.className = 'alert alert-error';
        mensagemDiv.textContent = '‚ùå Erro ao conectar com o servidor: ' + error.message;
        mensagemDiv.style.display = 'block';
    }
});
</script>
{% endblock %}
